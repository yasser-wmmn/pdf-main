<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <title>تحويل المستندات إلى Word - نسخة الويب</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- مكتبات المعالجة (Client-Side) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="side-shape shape1"></div>
    <div class="side-shape shape2"></div>
    <div class="side-shape shape3"></div>
    <div class="side-shape shape4"></div>
    <div class="side-shape shape5"></div>

    <div class="header-logo"></div>

    <div class="upload-container">
        <h2>تحويل المستندات إلى Word (Web Version)</h2>
        <p style="color: #aaa; margin-bottom: 20px;">يعمل بالكامل في متصفحك! لا يتم رفع ملفاتك لأي خادم.</p>

        <label for="file_input" class="custom-file-upload">
            <i class="fas fa-cloud-upload-alt upload-icon"></i>
            انقر لاختيار ملف (PDF أو صورة)
            <input id="file_input" type="file" accept=".pdf,.jpg,.jpeg,.png,.webp" style="display:none">
            <span id="file-name"></span>
        </label>

        <button id="convert-btn" disabled>بدء التحويل</button>

        <div class="progress-container" id="progress-container">
            <div class="progress-bar-bg">
                <div class="progress-bar-fill" id="progress-fill"></div>
            </div>
            <div class="status-text" id="status-text">جاري التحميل...</div>
        </div>

        <div class="success-area" id="success-area">
            <p>✅ تم التحويل بنجاح!</p>
            <button id="download-btn" style="background: #4caf50;">تحميل ملف Word</button>
        </div>

        <div class="note">
            يدعم اللغة العربية والإنجليزية.<br>
            يعتمد سرعة التحويل على سرعة جهازك (المعالجة تتم محلياً).
        </div>
    </div>

    <script>
        // إعداد PDF.js Worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        const fileInput = document.getElementById('file_input');
        const fileNameSpan = document.getElementById('file-name');
        const convertBtn = document.getElementById('convert-btn');
        const progressContainer = document.getElementById('progress-container');
        const progressFill = document.getElementById('progress-fill');
        const statusText = document.getElementById('status-text');
        const successArea = document.getElementById('success-area');
        const downloadBtn = document.getElementById('download-btn');

        let selectedFile = null;
        let generatedDocBlob = null;

        fileInput.addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                selectedFile = e.target.files[0];
                fileNameSpan.textContent = selectedFile.name;
                convertBtn.disabled = false;
                successArea.style.display = 'none';
            }
        });

        convertBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            convertBtn.disabled = true;
            convertBtn.style.opacity = '0.5';
            progressContainer.style.display = 'block';
            successArea.style.display = 'none';
            updateProgress(0, "جاري تهيئة المحرك...");

            try {
                let textPages = [];

                if (selectedFile.type === 'application/pdf') {
                    textPages = await processPDF(selectedFile);
                } else if (selectedFile.type.startsWith('image/')) {
                    textPages = await processImage(selectedFile);
                } else {
                    alert('نوع الملف غير مدعوم');
                    resetUI();
                    return;
                }

                updateProgress(90, "جاري إنشاء ملف Word...");
                generatedDocBlob = await createWordDoc(textPages);

                updateProgress(100, "تم الانتهاء!");
                successArea.style.display = 'block';

                // تحميل تلقائي أو يدوي
                downloadBtn.onclick = () => {
                    saveAs(generatedDocBlob, `converted_${selectedFile.name.split('.')[0]}.docx`);
                };

            } catch (err) {
                console.error(err);
                alert(`حدث خطأ: ${err.message}`);
            } finally {
                convertBtn.disabled = false;
                convertBtn.style.opacity = '1';
            }
        });

        function resetUI() {
            convertBtn.disabled = false;
            convertBtn.style.opacity = '1';
            progressContainer.style.display = 'none';
        }

        function updateProgress(percent, text) {
            progressFill.style.width = `${percent}%`;
            statusText.textContent = text;
        }

        async function processImage(file) {
            updateProgress(20, "جاري تحليل الصورة (OCR)...");
            const text = await performOCR(file);
            return [{ text: text }];
        }

        async function processPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            const totalPages = pdf.numPages;
            let pagesContent = [];

            for (let i = 1; i <= totalPages; i++) {
                updateProgress(Math.round((i / totalPages) * 80), `جارٍ معالجة الصفحة ${i} من ${totalPages}...`);

                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 2.0 }); // دقة عالية للتعرف الأفضل
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({ canvasContext: context, viewport: viewport }).promise;

                // تحويل الكانفاس لصورة للـ OCR
                const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
                const text = await performOCR(blob);

                pagesContent.push({ text: text });
            }
            return pagesContent;
        }

        async function performOCR(imageBlob) {
            // استخدام Tesseract.js
            const worker = await Tesseract.createWorker('ara+eng');

            // تحسينات للغة العربية والمعالجة
            await worker.setParameters({
                tessedit_pageseg_mode: Tesseract.PSM.AUTO,
            });

            const ret = await worker.recognize(imageBlob);
            await worker.terminate();
            return ret.data.text;
        }

        async function createWordDoc(pages) {
            const { Document, Packer, Paragraph, TextRun, AlignmentType } = window.docx;

            const docChildren = [];

            // عنوان
            docChildren.push(
                new Paragraph({
                    text: selectedFile.name,
                    heading: window.docx.HeadingLevel.HEADING_1,
                    alignment: AlignmentType.CENTER,
                    bidirectional: true // مهم للعربية
                })
            );

            pages.forEach((page, index) => {
                if (index > 0) {
                    // فاصل صفحات ممكن إضافته، هنا سنضع خط فاصل
                    docChildren.push(new Paragraph({ text: "------------------------------------------------", alignment: AlignmentType.CENTER }));
                }

                const lines = page.text.split('\n');
                lines.forEach(line => {
                    const cleanLine = line.trim();
                    if (cleanLine) {
                        docChildren.push(
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: cleanLine,
                                        size: 24, // 12pt
                                        font: "Arial",
                                        rightToLeft: true // تفعيل اتجاه النص
                                    })
                                ],
                                bidirectional: true, // تفعيل اتجاه الفقرة
                                alignment: AlignmentType.RIGHT // محاذاة لليمين افتراضياً
                            })
                        );
                    }
                });
            });

            const doc = new Document({
                sections: [{
                    properties: {},
                    children: docChildren,
                }],
            });

            return await Packer.toBlob(doc);
        }
    </script>
</body>

</html>